<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®€æŠ¥ Â· æ¯æ—¥ç²¾é€‰</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Playfair+Display:wght@700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #1a1814;
      --ink-light: #4a453e;
      --ink-faint: #8a847c;
      --paper: #f5f0e8;
      --paper-dark: #ede8dc;
      --accent: #c0392b;
      --accent-gold: #b8860b;
      --border: #d4cfc5;
      --serif: 'Noto Serif SC', 'Playfair Display', serif;
      --mono: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--paper);
      color: var(--ink);
      font-family: var(--serif);
      min-height: 100vh;
      background-image: 
        radial-gradient(ellipse at 20% 0%, rgba(192,57,43,0.04) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(184,134,11,0.04) 0%, transparent 50%);
    }

    /* MASTHEAD */
    .masthead {
      border-bottom: 3px double var(--ink);
      padding: 24px 40px 16px;
      text-align: center;
      position: relative;
    }
    .masthead::before {
      content: '';
      display: block;
      border-top: 1px solid var(--ink);
      margin-bottom: 16px;
    }
    .masthead-title {
      font-family: 'Playfair Display', var(--serif);
      font-size: clamp(2.5rem, 6vw, 4rem);
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1;
      color: var(--ink);
    }
    .masthead-title span {
      color: var(--accent);
    }
    .masthead-subtitle {
      font-family: var(--mono);
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      color: var(--ink-faint);
      margin-top: 8px;
      text-transform: uppercase;
    }
    .masthead-date {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--ink-faint);
      margin-top: 4px;
      letter-spacing: 0.1em;
    }

    /* CONTROL PANEL */
    .control-panel {
      border-bottom: 1px solid var(--border);
      background: var(--paper-dark);
      padding: 20px 40px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .control-label {
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--ink-faint);
    }

    .keyword-input-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    input[type="text"] {
      background: var(--paper);
      border: 1px solid var(--border);
      color: var(--ink);
      font-family: var(--serif);
      font-size: 0.9rem;
      padding: 8px 12px;
      outline: none;
      transition: border-color 0.2s;
      width: 220px;
    }
    input[type="text"]:focus {
      border-color: var(--ink);
    }
    input[type="text"]::placeholder {
      color: var(--ink-faint);
    }

    .btn {
      font-family: var(--mono);
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 8px 16px;
      border: 1px solid var(--ink);
      background: var(--ink);
      color: var(--paper);
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn:hover { background: var(--accent); border-color: var(--accent); }
    .btn-outline {
      background: transparent;
      color: var(--ink);
    }
    .btn-outline:hover { background: var(--ink); color: var(--paper); }
    .btn-fetch {
      background: var(--accent);
      border-color: var(--accent);
      padding: 8px 24px;
      font-size: 0.8rem;
    }
    .btn-fetch:hover { background: #a93226; border-color: #a93226; }

    .keyword-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      max-width: 500px;
    }
    .tag {
      font-family: var(--mono);
      font-size: 0.7rem;
      background: var(--ink);
      color: var(--paper);
      padding: 4px 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      letter-spacing: 0.05em;
    }
    .tag-remove {
      cursor: pointer;
      opacity: 0.6;
      font-size: 0.8rem;
      line-height: 1;
    }
    .tag-remove:hover { opacity: 1; }

    .time-select {
      background: var(--paper);
      border: 1px solid var(--border);
      color: var(--ink);
      font-family: var(--mono);
      font-size: 0.75rem;
      padding: 8px 12px;
      outline: none;
      cursor: pointer;
      letter-spacing: 0.05em;
    }

    /* API KEY SECTION */
    .api-section {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .api-key-input {
      width: 280px;
      font-family: var(--mono) !important;
      font-size: 0.75rem !important;
      letter-spacing: 0.05em;
    }
    .api-status {
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 0.1em;
    }
    .api-status.ok { color: #27ae60; }
    .api-status.err { color: var(--accent); }

    /* MAIN CONTENT */
    .main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 40px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--ink);
    }
    .section-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .section-count {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--ink-faint);
      letter-spacing: 0.1em;
    }

    /* NEWS CARDS */
    .news-grid {
      display: grid;
      gap: 0;
    }

    .news-card {
      border-bottom: 1px solid var(--border);
      padding: 24px 0;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: start;
      animation: fadeIn 0.4s ease both;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .news-card:first-child { border-top: 1px solid var(--border); }

    .news-keyword-badge {
      font-family: var(--mono);
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .news-headline {
      font-size: 1.15rem;
      font-weight: 600;
      line-height: 1.4;
      color: var(--ink);
      margin-bottom: 10px;
    }

    .news-summary {
      font-size: 0.88rem;
      line-height: 1.75;
      color: var(--ink-light);
      margin-bottom: 12px;
    }

    .news-sources {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .source-link {
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 0.05em;
      color: var(--ink-faint);
      text-decoration: none;
      border-bottom: 1px solid var(--border);
      padding-bottom: 1px;
      transition: color 0.15s, border-color 0.15s;
    }
    .source-link:hover { color: var(--accent); border-color: var(--accent); }

    .news-meta {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--ink-faint);
      letter-spacing: 0.08em;
      text-align: right;
      white-space: nowrap;
    }

    /* STATES */
    .state-empty {
      text-align: center;
      padding: 80px 20px;
      color: var(--ink-faint);
    }
    .state-empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    .state-empty-text {
      font-family: var(--mono);
      font-size: 0.8rem;
      letter-spacing: 0.1em;
      line-height: 1.8;
    }

    .state-loading {
      text-align: center;
      padding: 80px 20px;
    }
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--ink);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--ink-faint);
      letter-spacing: 0.1em;
    }

    .error-banner {
      background: #fdf0ef;
      border: 1px solid var(--accent);
      padding: 16px 20px;
      margin-bottom: 24px;
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--accent);
      letter-spacing: 0.05em;
      line-height: 1.6;
    }

    /* SETTINGS MODAL */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(26,24,20,0.7);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .modal-overlay.open {
      opacity: 1;
      pointer-events: all;
    }
    .modal {
      background: var(--paper);
      border: 1px solid var(--ink);
      padding: 32px;
      max-width: 520px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .modal-section {
      margin-bottom: 20px;
    }
    .modal-label {
      font-family: var(--mono);
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--ink-faint);
      margin-bottom: 8px;
    }
    .modal-desc {
      font-size: 0.8rem;
      color: var(--ink-light);
      line-height: 1.6;
      margin-bottom: 10px;
    }
    .modal-desc a {
      color: var(--accent);
    }
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    /* SOURCE TOGGLES */
    .source-toggles {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .source-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: var(--mono);
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      cursor: pointer;
      user-select: none;
      color: var(--ink-light);
    }
    .source-toggle input[type="checkbox"] {
      accent-color: var(--accent);
      width: 14px;
      height: 14px;
    }
    .source-toggle.yt { color: #c0392b; }
    .source-toggle.bili { color: #00aeec; }

    /* VIDEO CARDS */
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 4px;
    }
    .video-card {
      border: 1px solid var(--border);
      background: var(--paper-dark);
      padding: 0;
      overflow: hidden;
      animation: fadeIn 0.4s ease both;
      display: flex;
      flex-direction: column;
    }
    .video-thumb {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      display: block;
      background: var(--border);
    }
    .video-thumb-placeholder {
      width: 100%;
      aspect-ratio: 16/9;
      background: var(--paper-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      border-bottom: 1px solid var(--border);
    }
    .video-body {
      padding: 14px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .video-platform {
      font-family: var(--mono);
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }
    .video-platform.yt { color: #c0392b; }
    .video-platform.bili { color: #00aeec; }
    .video-title {
      font-size: 0.9rem;
      font-weight: 600;
      line-height: 1.45;
      color: var(--ink);
      text-decoration: none;
      display: block;
    }
    .video-title:hover { color: var(--accent); }
    .video-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
    }
    .video-channel {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--ink-faint);
    }
    .video-date {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--ink-faint);
    }

    /* TABS */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--ink);
      margin-bottom: 24px;
    }
    .tab {
      font-family: var(--mono);
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--ink-faint);
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.15s;
    }
    .tab.active {
      color: var(--ink);
      border-bottom-color: var(--accent);
    }
    .tab:hover { color: var(--ink); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* FOOTER */
    footer {
      text-align: center;
      padding: 24px;
      border-top: 1px solid var(--border);
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--ink-faint);
      letter-spacing: 0.1em;
    }

    @media (max-width: 640px) {
      .masthead { padding: 16px 20px; }
      .control-panel { padding: 16px 20px; }
      .main { padding: 24px 20px; }
      .news-card { grid-template-columns: 1fr; }
      .news-meta { text-align: left; }
      input[type="text"] { width: 160px; }
      .api-key-input { width: 200px !important; }
    }
  </style>
</head>
<body>

  <header class="masthead">
    <div class="masthead-title">ç®€<span>æŠ¥</span></div>
    <div class="masthead-subtitle">ä¸ªäººæ–°é—»èšåˆ Â· Personal News Digest</div>
    <div class="masthead-date" id="todayDate"></div>
  </header>

  <div class="control-panel">
    <!-- å…³é”®è¯ -->
    <div class="control-group" style="flex:1;min-width:280px">
      <div class="control-label">å…³é”®è¯</div>
      <div class="keyword-input-row">
        <input type="text" id="kwInput" placeholder="è¾“å…¥å…³é”®è¯ï¼Œå›è½¦æ·»åŠ " maxlength="50" />
        <button class="btn btn-outline" onclick="addKeyword()">æ·»åŠ </button>
      </div>
      <div class="keyword-tags" id="kwTags"></div>
    </div>

    <!-- æ—¶é—´èŒƒå›´ -->
    <div class="control-group">
      <div class="control-label">æ—¶é—´èŒƒå›´</div>
      <select class="time-select" id="timeRange">
        <option value="1">ä»Šå¤©</option>
        <option value="3" selected>æœ€è¿‘3å¤©</option>
        <option value="7">æœ€è¿‘1å‘¨</option>
        <option value="14">æœ€è¿‘2å‘¨</option>
        <option value="30">æœ€è¿‘1ä¸ªæœˆ</option>
      </select>
    </div>

    <!-- è·å–æŒ‰é’® -->
    <div class="control-group">
      <div class="control-label">&nbsp;</div>
      <button class="btn btn-fetch" onclick="fetchNews()">â–¶ è·å–æ–°é—»</button>
    </div>

    <!-- æ¥æºé€‰æ‹© -->
    <div class="control-group">
      <div class="control-label">æ•°æ®æ¥æº</div>
      <div class="source-toggles">
        <label class="source-toggle"><input type="checkbox" id="srcNews" checked /> æ–°é—»</label>
        <label class="source-toggle yt"><input type="checkbox" id="srcYoutube" checked /> YouTube</label>
        <label class="source-toggle bili"><input type="checkbox" id="srcBilibili" /> Bç«™</label>
      </div>
    </div>

    <!-- è®¾ç½® -->
    <div class="control-group">
      <div class="control-label">&nbsp;</div>
      <button class="btn btn-outline" onclick="openSettings()">âš™ è®¾ç½®</button>
    </div>
  </div>

  <main class="main">
    <div id="errorBanner" class="error-banner" style="display:none"></div>
    <div id="mainContent">
      <div class="state-empty">
        <div class="state-empty-icon">ğŸ“°</div>
        <div class="state-empty-text">
          æ·»åŠ å…³é”®è¯ï¼Œé€‰æ‹©æ—¶é—´èŒƒå›´<br>ç‚¹å‡»ã€Œè·å–æ–°é—»ã€å¼€å§‹
        </div>
      </div>
    </div>
  </main>

  <footer>ç®€æŠ¥ Â· æ•°æ®æ¥æºï¼šGoogle News / YouTube / Bilibili Â· æ‘˜è¦ç”± Gemini AI ç”Ÿæˆ</footer>

  <!-- è®¾ç½®å¼¹çª— -->
  <div class="modal-overlay" id="settingsModal" onclick="closeSettingsOutside(event)">
    <div class="modal">
      <div class="modal-title">âš™ è®¾ç½®</div>

      <div class="modal-section">
        <div class="modal-label">Gemini API Key</div>
        <div class="modal-desc">
          ç”¨äºæ–°é—»å»é‡å’Œä¸­æ–‡æ‘˜è¦ç”Ÿæˆã€‚<a href="https://aistudio.google.com/app/apikey" target="_blank">ç‚¹å‡»æ­¤å¤„å…è´¹ç”³è¯·</a>ï¼Œé€‰æ‹©å…è´¹å¥—é¤å³å¯ã€‚
        </div>
        <div style="display:flex;gap:8px">
          <input type="password" id="geminiKey" class="api-key-input" placeholder="AIza..." style="width:280px;font-family:monospace;font-size:0.75rem" />
          <button class="btn btn-outline" onclick="saveApiKey()">ä¿å­˜</button>
        </div>
        <div class="api-status" id="apiStatus" style="margin-top:6px"></div>
      </div>

      <div class="modal-section">
        <div class="modal-label">NewsAPI Keyï¼ˆå¯é€‰ï¼‰</div>
        <div class="modal-desc">
          ç”¨äºè·å–æ›´å¤šè‹±æ–‡æ–°é—»æ¥æºã€‚<a href="https://newsapi.org/register" target="_blank">ç‚¹å‡»æ­¤å¤„å…è´¹ç”³è¯·</a>ã€‚ä¸å¡«åˆ™åªä½¿ç”¨ Google Newsã€‚
        </div>
        <div style="display:flex;gap:8px">
          <input type="text" id="newsapiKey" class="api-key-input" placeholder="ç•™ç©ºåˆ™ä¸ä½¿ç”¨" style="width:280px;font-family:monospace;font-size:0.75rem" />
          <button class="btn btn-outline" onclick="saveNewsApiKey()">ä¿å­˜</button>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeSettings()">å…³é—­</button>
      </div>
    </div>
  </div>

<script>
// â”€â”€â”€ çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let keywords = JSON.parse(localStorage.getItem('jb_keywords') || '["Gemini","ç‰¹æœ—æ™®","é»„é‡‘","AI"]');
let geminiKey = localStorage.getItem('jb_gemini_key') || '';
let newsapiKey = localStorage.getItem('jb_newsapi_key') || '';

// â”€â”€â”€ åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('todayDate').textContent = new Date().toLocaleDateString('zh-CN', {
  year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
});
document.getElementById('kwInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') addKeyword();
});
renderTags();

function renderTags() {
  const el = document.getElementById('kwTags');
  el.innerHTML = keywords.map((kw, i) => `
    <div class="tag">
      ${escHtml(kw)}
      <span class="tag-remove" onclick="removeKeyword(${i})">âœ•</span>
    </div>
  `).join('');
}
function addKeyword() {
  const v = document.getElementById('kwInput').value.trim();
  if (v && !keywords.includes(v)) {
    keywords.push(v);
    localStorage.setItem('jb_keywords', JSON.stringify(keywords));
    renderTags();
  }
  document.getElementById('kwInput').value = '';
}
function removeKeyword(i) {
  keywords.splice(i, 1);
  localStorage.setItem('jb_keywords', JSON.stringify(keywords));
  renderTags();
}
function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€ è®¾ç½®å¼¹çª— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSettings() {
  document.getElementById('geminiKey').value = geminiKey;
  document.getElementById('newsapiKey').value = newsapiKey;
  document.getElementById('apiStatus').textContent = '';
  document.getElementById('settingsModal').classList.add('open');
}
function closeSettings() {
  document.getElementById('settingsModal').classList.remove('open');
}
function closeSettingsOutside(e) {
  if (e.target === document.getElementById('settingsModal')) closeSettings();
}
function saveApiKey() {
  const v = document.getElementById('geminiKey').value.trim();
  geminiKey = v;
  localStorage.setItem('jb_gemini_key', v);
  const st = document.getElementById('apiStatus');
  st.textContent = v ? 'âœ“ å·²ä¿å­˜' : 'å·²æ¸…é™¤';
  st.className = 'api-status ok';
}
function saveNewsApiKey() {
  const v = document.getElementById('newsapiKey').value.trim();
  newsapiKey = v;
  localStorage.setItem('jb_newsapi_key', v);
}

// â”€â”€â”€ Tab åˆ‡æ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + name));
}

// â”€â”€â”€ æ ¸å¿ƒï¼šè·å–æ‰€æœ‰å†…å®¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchNews() {
  if (!keywords.length) { showError('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ªå…³é”®è¯'); return; }
  if (!geminiKey) { showError('è¯·å…ˆåœ¨ã€Œè®¾ç½®ã€ä¸­å¡«å†™ Gemini API Key'); openSettings(); return; }

  const days = parseInt(document.getElementById('timeRange').value);
  const wantNews = document.getElementById('srcNews').checked;
  const wantYT = document.getElementById('srcYoutube').checked;
  const wantBili = document.getElementById('srcBilibili').checked;

  showLoading();
  hideError();

  try {
    const [newsGroups, videos] = await Promise.all([
      wantNews ? fetchAndGroupNews(days) : Promise.resolve([]),
      fetchVideos(days, wantYT, wantBili)
    ]);
    renderAll(newsGroups, videos, days, wantNews, wantYT || wantBili);
  } catch (err) {
    console.error(err);
    showError('è·å–å¤±è´¥ï¼š' + err.message);
  }
}

// â”€â”€â”€ æ–°é—»æŠ“å– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchAndGroupNews(days) {
  let allArticles = [];
  for (const kw of keywords) {
    const a = await fetchGoogleNews(kw, days);
    allArticles = allArticles.concat(a.map(x => ({...x, keyword: kw})));
  }
  if (newsapiKey) {
    for (const kw of keywords) {
      const a = await fetchNewsAPI(kw, days);
      allArticles = allArticles.concat(a.map(x => ({...x, keyword: kw})));
    }
  }
  if (!allArticles.length) return [];
  return groupAndSummarize(allArticles, days);
}

async function fetchGoogleNews(keyword, days) {
  try {
    const url = `https://news.google.com/rss/search?q=${encodeURIComponent(keyword)}&hl=zh-CN&gl=CN&ceid=CN:zh-Hans`;
    const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    const res = await fetch(proxy);
    const data = await res.json();
    const parser = new DOMParser();
    const xml = parser.parseFromString(data.contents, 'text/xml');
    const items = xml.querySelectorAll('item');
    const cutoff = Date.now() - days * 86400000;
    const articles = [];
    items.forEach(item => {
      const pubDate = new Date(item.querySelector('pubDate')?.textContent || 0);
      if (pubDate.getTime() < cutoff) return;
      articles.push({
        title: item.querySelector('title')?.textContent || '',
        link: item.querySelector('link')?.textContent || '',
        source: item.querySelector('source')?.textContent || 'Google News',
        publishedAt: pubDate.toISOString()
      });
    });
    return articles.slice(0, 15);
  } catch(e) { return []; }
}

async function fetchNewsAPI(keyword, days) {
  try {
    const from = new Date(Date.now() - days * 86400000).toISOString().split('T')[0];
    const url = `https://newsapi.org/v2/everything?q=${encodeURIComponent(keyword)}&from=${from}&sortBy=publishedAt&pageSize=10&apiKey=${newsapiKey}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.status !== 'ok') return [];
    return (data.articles || []).map(a => ({
      title: a.title, link: a.url,
      source: a.source?.name || 'NewsAPI', publishedAt: a.publishedAt
    }));
  } catch(e) { return []; }
}

// â”€â”€â”€ è§†é¢‘æŠ“å– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchVideos(days, wantYT, wantBili) {
  const cutoff = Date.now() - days * 86400000;
  let all = [];

  for (const kw of keywords) {
    if (wantYT) {
      const ytVideos = await fetchYouTubeVideos(kw, cutoff);
      all = all.concat(ytVideos);
    }
    if (wantBili) {
      const biliVideos = await fetchBiliVideos(kw, cutoff);
      all = all.concat(biliVideos);
    }
  }

  // æŒ‰æ—¶é—´å€’åº
  all.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
  return all;
}

async function fetchYouTubeVideos(keyword, cutoff) {
  try {
    // YouTube search RSS via allorigins proxy
    const url = `https://www.youtube.com/feeds/videos.xml?q=${encodeURIComponent(keyword)}`;
    // YouTube doesn't have a search RSS, use invidious public API instead
    const invRes = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://inv.nadeko.net/api/v1/search?q=${encodeURIComponent(keyword)}&type=video&sort_by=upload_date`)}`);
    const invData = await invRes.json();
    const items = JSON.parse(invData.contents || '[]');
    return items
      .filter(v => v.type === 'video')
      .map(v => ({
        platform: 'youtube',
        keyword,
        title: v.title,
        url: `https://www.youtube.com/watch?v=${v.videoId}`,
        channel: v.author,
        thumbnail: v.videoThumbnails?.[0]?.url || '',
        publishedAt: new Date(v.published * 1000).toISOString()
      }))
      .filter(v => new Date(v.publishedAt).getTime() >= cutoff)
      .slice(0, 8);
  } catch(e) { return []; }
}

async function fetchBiliVideos(keyword, cutoff) {
  try {
    const url = `https://search.bilibili.com/all?keyword=${encodeURIComponent(keyword)}&order=pubdate&duration=0&tids=0`;
    // Use RSSHub for Bilibili search
    const rssUrl = `https://rsshub.app/bilibili/search/${encodeURIComponent(keyword)}?order=pubdate&category=0&duration=0`;
    const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`;
    const res = await fetch(proxy);
    const data = await res.json();
    const parser = new DOMParser();
    const xml = parser.parseFromString(data.contents, 'text/xml');
    const items = xml.querySelectorAll('item');
    const videos = [];
    items.forEach(item => {
      const pubDate = new Date(item.querySelector('pubDate')?.textContent || 0);
      if (pubDate.getTime() < cutoff) return;
      const title = item.querySelector('title')?.textContent || '';
      const link = item.querySelector('link')?.textContent || '';
      // Try to get author from description or source
      const desc = item.querySelector('description')?.textContent || '';
      const authorMatch = desc.match(/UPä¸»[ï¼š:]\s*([^\s<]+)/);
      videos.push({
        platform: 'bilibili',
        keyword,
        title,
        url: link,
        channel: authorMatch ? authorMatch[1] : 'Bç«™',
        thumbnail: '',
        publishedAt: pubDate.toISOString()
      });
    });
    return videos.slice(0, 8);
  } catch(e) { return []; }
}

// â”€â”€â”€ Gemini å»é‡èšåˆï¼ˆä»…ç”¨äºæ–°é—»ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function groupAndSummarize(articles, days) {
  const byKeyword = {};
  articles.forEach(a => {
    if (!byKeyword[a.keyword]) byKeyword[a.keyword] = [];
    byKeyword[a.keyword].push(a);
  });

  const results = [];

  for (const [kw, arts] of Object.entries(byKeyword)) {
    if (!arts.length) continue;

    const articleList = arts.map((a, i) =>
      `${i+1}. æ ‡é¢˜ï¼š${a.title}\n   æ¥æºï¼š${a.source}\n   æ—¶é—´ï¼š${new Date(a.publishedAt).toLocaleDateString('zh-CN')}\n   é“¾æ¥ï¼š${a.link}`
    ).join('\n\n');

    const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–°é—»ç¼–è¾‘ã€‚ä»¥ä¸‹æ˜¯å…³äºå…³é”®è¯ã€Œ${kw}ã€åœ¨æœ€è¿‘${days}å¤©å†…æ”¶é›†åˆ°çš„æ–°é—»åˆ—è¡¨ï¼š

${articleList}

è¯·å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š
1. å°†å†…å®¹ç›¸ä¼¼æˆ–åŒä¸€äº‹ä»¶çš„æ–°é—»å½’ä¸ºä¸€ç»„
2. å¯¹æ¯ç»„ç”Ÿæˆä¸€ä¸ªç®€æ´çš„ä¸­æ–‡æ ‡é¢˜ï¼ˆ15å­—ä»¥å†…ï¼‰
3. å¯¹æ¯ç»„ç”Ÿæˆä¸€æ®µä¸­æ–‡æ‘˜è¦ï¼ˆ100-150å­—ï¼‰ï¼Œæ¦‚æ‹¬æ ¸å¿ƒäº‹ä»¶ã€æ—¶é—´ã€å½±å“
4. æ¯ç»„ä¿ç•™æ‰€æœ‰æ¥æºé“¾æ¥

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ï¼š
[{"headline":"èšåˆæ ‡é¢˜","summary":"ä¸­æ–‡æ‘˜è¦å†…å®¹","sources":[{"name":"æ¥æºå","url":"é“¾æ¥","date":"æ—¥æœŸ"}]}]`;

    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.3, maxOutputTokens: 2048 }
        })
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error.message);
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '[]';
      const groups = JSON.parse(text.replace(/```json|```/g, '').trim());
      groups.forEach(g => results.push({ ...g, keyword: kw }));
    } catch (e) {
      arts.forEach(a => results.push({
        headline: a.title, summary: '',
        sources: [{ name: a.source, url: a.link, date: new Date(a.publishedAt).toLocaleDateString('zh-CN') }],
        keyword: kw
      }));
    }
  }
  return results;
}

// â”€â”€â”€ æ¸²æŸ“å…¨éƒ¨å†…å®¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll(newsGroups, videos, days, showNews, showVideo) {
  const container = document.getElementById('mainContent');
  const timeLabel = document.getElementById('timeRange').options[document.getElementById('timeRange').selectedIndex].text;

  const tabs = [];
  if (showNews) tabs.push({ id: 'news', label: `æ–°é—»æ‘˜è¦ (${newsGroups.length})` });
  if (showVideo) tabs.push({ id: 'video', label: `è§†é¢‘ (${videos.length})` });

  if (!tabs.length) { container.innerHTML = '<div class="state-empty"><div class="state-empty-icon">âš™</div><div class="state-empty-text">è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ•°æ®æ¥æº</div></div>'; return; }

  container.innerHTML = `
    <div class="tabs">
      ${tabs.map((t, i) => `<button class="tab${i===0?' active':''}" data-tab="${t.id}" onclick="switchTab('${t.id}')">${t.label}</button>`).join('')}
      <span style="margin-left:auto;font-family:var(--mono);font-size:0.65rem;color:var(--ink-faint);align-self:center">${timeLabel}</span>
    </div>

    ${showNews ? `
    <div class="tab-panel${tabs[0].id==='news'?' active':''}" id="panel-news">
      ${newsGroups.length ? `
        <div class="news-grid">
          ${newsGroups.map((g, i) => `
            <div class="news-card" style="animation-delay:${i*0.05}s">
              <div>
                <div class="news-keyword-badge"># ${escHtml(g.keyword)}</div>
                <div class="news-headline">${escHtml(g.headline)}</div>
                ${g.summary ? `<div class="news-summary">${escHtml(g.summary)}</div>` : ''}
                <div class="news-sources">
                  ${g.sources.map(s => `<a class="source-link" href="${escHtml(s.url)}" target="_blank" rel="noopener">${escHtml(s.name)}${s.date?' Â· '+escHtml(s.date):''}</a>`).join('')}
                </div>
              </div>
              <div class="news-meta">${g.sources.length} ä¸ªæ¥æº</div>
            </div>
          `).join('')}
        </div>
      ` : '<div class="state-empty"><div class="state-empty-icon">ğŸ”</div><div class="state-empty-text">æœªæ‰¾åˆ°ç›¸å…³æ–°é—»</div></div>'}
    </div>` : ''}

    ${showVideo ? `
    <div class="tab-panel${tabs[0].id==='video'?' active':''}" id="panel-video">
      ${videos.length ? `
        <div class="video-grid">
          ${videos.map((v, i) => `
            <div class="video-card" style="animation-delay:${i*0.04}s">
              ${v.thumbnail
                ? `<img class="video-thumb" src="${escHtml(v.thumbnail)}" loading="lazy" onerror="this.style.display='none'" />`
                : `<div class="video-thumb-placeholder">${v.platform==='youtube'?'â–¶':'ğŸ“º'}</div>`}
              <div class="video-body">
                <div class="video-platform ${v.platform==='youtube'?'yt':'bili'}">${v.platform==='youtube'?'YouTube':'Bilibili'} Â· # ${escHtml(v.keyword)}</div>
                <a class="video-title" href="${escHtml(v.url)}" target="_blank" rel="noopener">${escHtml(v.title)}</a>
                <div class="video-meta-row">
                  <div class="video-channel">${escHtml(v.channel)}</div>
                  <div class="video-date">${new Date(v.publishedAt).toLocaleDateString('zh-CN')}</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : '<div class="state-empty"><div class="state-empty-icon">ğŸ¬</div><div class="state-empty-text">æœªæ‰¾åˆ°ç›¸å…³è§†é¢‘<br><small style="opacity:0.6">Bç«™éœ€è¦ RSSHub æœåŠ¡å¯ç”¨</small></div></div>'}
    </div>` : ''}
  `;
}

// â”€â”€â”€ å·¥å…·å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLoading() {
  document.getElementById('mainContent').innerHTML = `
    <div class="state-loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">æ­£åœ¨æŠ“å–å¹¶åˆ†æå†…å®¹ï¼Œè¯·ç¨å€™â€¦</div>
    </div>
  `;
}
function showError(msg) {
  const el = document.getElementById('errorBanner');
  el.textContent = 'âš  ' + msg;
  el.style.display = 'block';
}
function hideError() {
  document.getElementById('errorBanner').style.display = 'none';
}
</script>
</body>
</html>
