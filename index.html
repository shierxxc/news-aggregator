<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®€æŠ¥ Â· æ¯æ—¥ç²¾é€‰</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Playfair+Display:wght@700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #1a1814;
      --ink-light: #4a453e;
      --ink-faint: #8a847c;
      --paper: #f5f0e8;
      --paper-dark: #ede8dc;
      --accent: #c0392b;
      --accent-gold: #b8860b;
      --border: #d4cfc5;
      --serif: 'Noto Serif SC', 'Playfair Display', serif;
      --mono: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--paper);
      color: var(--ink);
      font-family: var(--serif);
      min-height: 100vh;
      background-image: 
        radial-gradient(ellipse at 20% 0%, rgba(192,57,43,0.04) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(184,134,11,0.04) 0%, transparent 50%);
    }

    /* MASTHEAD */
    .masthead {
      border-bottom: 3px double var(--ink);
      padding: 24px 40px 16px;
      text-align: center;
      position: relative;
    }
    .masthead::before {
      content: '';
      display: block;
      border-top: 1px solid var(--ink);
      margin-bottom: 16px;
    }
    .masthead-title {
      font-family: 'Playfair Display', var(--serif);
      font-size: clamp(2.5rem, 6vw, 4rem);
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1;
      color: var(--ink);
    }
    .masthead-title span {
      color: var(--accent);
    }
    .masthead-subtitle {
      font-family: var(--mono);
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      color: var(--ink-faint);
      margin-top: 8px;
      text-transform: uppercase;
    }
    .masthead-date {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--ink-faint);
      margin-top: 4px;
      letter-spacing: 0.1em;
    }

    /* CONTROL PANEL */
    .control-panel {
      border-bottom: 1px solid var(--border);
      background: var(--paper-dark);
      padding: 20px 40px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .control-label {
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--ink-faint);
    }

    .keyword-input-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    input[type="text"] {
      background: var(--paper);
      border: 1px solid var(--border);
      color: var(--ink);
      font-family: var(--serif);
      font-size: 0.9rem;
      padding: 8px 12px;
      outline: none;
      transition: border-color 0.2s;
      width: 220px;
    }
    input[type="text"]:focus {
      border-color: var(--ink);
    }
    input[type="text"]::placeholder {
      color: var(--ink-faint);
    }

    .btn {
      font-family: var(--mono);
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 8px 16px;
      border: 1px solid var(--ink);
      background: var(--ink);
      color: var(--paper);
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn:hover { background: var(--accent); border-color: var(--accent); }
    .btn-outline {
      background: transparent;
      color: var(--ink);
    }
    .btn-outline:hover { background: var(--ink); color: var(--paper); }
    .btn-fetch {
      background: var(--accent);
      border-color: var(--accent);
      padding: 8px 24px;
      font-size: 0.8rem;
    }
    .btn-fetch:hover { background: #a93226; border-color: #a93226; }

    .keyword-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      max-width: 500px;
    }
    .tag {
      font-family: var(--mono);
      font-size: 0.7rem;
      background: var(--ink);
      color: var(--paper);
      padding: 4px 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      letter-spacing: 0.05em;
    }
    .tag-remove {
      cursor: pointer;
      opacity: 0.6;
      font-size: 0.8rem;
      line-height: 1;
    }
    .tag-remove:hover { opacity: 1; }

    .time-select {
      background: var(--paper);
      border: 1px solid var(--border);
      color: var(--ink);
      font-family: var(--mono);
      font-size: 0.75rem;
      padding: 8px 12px;
      outline: none;
      cursor: pointer;
      letter-spacing: 0.05em;
    }

    /* API KEY SECTION */
    .api-section {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .api-key-input {
      width: 280px;
      font-family: var(--mono) !important;
      font-size: 0.75rem !important;
      letter-spacing: 0.05em;
    }
    .api-status {
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 0.1em;
    }
    .api-status.ok { color: #27ae60; }
    .api-status.err { color: var(--accent); }

    /* MAIN CONTENT */
    .main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 40px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--ink);
    }
    .section-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .section-count {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--ink-faint);
      letter-spacing: 0.1em;
    }

    /* NEWS CARDS */
    .news-grid {
      display: grid;
      gap: 0;
    }

    .news-card {
      border-bottom: 1px solid var(--border);
      padding: 24px 0;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: start;
      animation: fadeIn 0.4s ease both;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .news-card:first-child { border-top: 1px solid var(--border); }

    .news-keyword-badge {
      font-family: var(--mono);
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .news-headline {
      font-size: 1.15rem;
      font-weight: 600;
      line-height: 1.4;
      color: var(--ink);
      margin-bottom: 10px;
    }

    .news-summary {
      font-size: 0.88rem;
      line-height: 1.75;
      color: var(--ink-light);
      margin-bottom: 12px;
    }

    .news-sources {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .source-link {
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 0.05em;
      color: var(--ink-faint);
      text-decoration: none;
      border-bottom: 1px solid var(--border);
      padding-bottom: 1px;
      transition: color 0.15s, border-color 0.15s;
    }
    .source-link:hover { color: var(--accent); border-color: var(--accent); }

    .news-meta {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--ink-faint);
      letter-spacing: 0.08em;
      text-align: right;
      white-space: nowrap;
    }

    /* STATES */
    .state-empty {
      text-align: center;
      padding: 80px 20px;
      color: var(--ink-faint);
    }
    .state-empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    .state-empty-text {
      font-family: var(--mono);
      font-size: 0.8rem;
      letter-spacing: 0.1em;
      line-height: 1.8;
    }

    .state-loading {
      text-align: center;
      padding: 80px 20px;
    }
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--ink);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--ink-faint);
      letter-spacing: 0.1em;
    }

    .error-banner {
      background: #fdf0ef;
      border: 1px solid var(--accent);
      padding: 16px 20px;
      margin-bottom: 24px;
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--accent);
      letter-spacing: 0.05em;
      line-height: 1.6;
    }

    /* SETTINGS MODAL */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(26,24,20,0.7);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .modal-overlay.open {
      opacity: 1;
      pointer-events: all;
    }
    .modal {
      background: var(--paper);
      border: 1px solid var(--ink);
      padding: 32px;
      max-width: 520px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .modal-section {
      margin-bottom: 20px;
    }
    .modal-label {
      font-family: var(--mono);
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--ink-faint);
      margin-bottom: 8px;
    }
    .modal-desc {
      font-size: 0.8rem;
      color: var(--ink-light);
      line-height: 1.6;
      margin-bottom: 10px;
    }
    .modal-desc a {
      color: var(--accent);
    }
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    /* FOOTER */
    footer {
      text-align: center;
      padding: 24px;
      border-top: 1px solid var(--border);
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--ink-faint);
      letter-spacing: 0.1em;
    }

    @media (max-width: 640px) {
      .masthead { padding: 16px 20px; }
      .control-panel { padding: 16px 20px; }
      .main { padding: 24px 20px; }
      .news-card { grid-template-columns: 1fr; }
      .news-meta { text-align: left; }
      input[type="text"] { width: 160px; }
      .api-key-input { width: 200px !important; }
    }
  </style>
</head>
<body>

  <header class="masthead">
    <div class="masthead-title">ç®€<span>æŠ¥</span></div>
    <div class="masthead-subtitle">ä¸ªäººæ–°é—»èšåˆ Â· Personal News Digest</div>
    <div class="masthead-date" id="todayDate"></div>
  </header>

  <div class="control-panel">
    <!-- å…³é”®è¯ -->
    <div class="control-group" style="flex:1;min-width:280px">
      <div class="control-label">å…³é”®è¯</div>
      <div class="keyword-input-row">
        <input type="text" id="kwInput" placeholder="è¾“å…¥å…³é”®è¯ï¼Œå›è½¦æ·»åŠ " maxlength="50" />
        <button class="btn btn-outline" onclick="addKeyword()">æ·»åŠ </button>
      </div>
      <div class="keyword-tags" id="kwTags"></div>
    </div>

    <!-- æ—¶é—´èŒƒå›´ -->
    <div class="control-group">
      <div class="control-label">æ—¶é—´èŒƒå›´</div>
      <select class="time-select" id="timeRange">
        <option value="1">ä»Šå¤©</option>
        <option value="3" selected>æœ€è¿‘3å¤©</option>
        <option value="7">æœ€è¿‘1å‘¨</option>
        <option value="14">æœ€è¿‘2å‘¨</option>
        <option value="30">æœ€è¿‘1ä¸ªæœˆ</option>
      </select>
    </div>

    <!-- è·å–æŒ‰é’® -->
    <div class="control-group">
      <div class="control-label">&nbsp;</div>
      <button class="btn btn-fetch" onclick="fetchNews()">â–¶ è·å–æ–°é—»</button>
    </div>

    <!-- è®¾ç½® -->
    <div class="control-group">
      <div class="control-label">&nbsp;</div>
      <button class="btn btn-outline" onclick="openSettings()">âš™ è®¾ç½®</button>
    </div>
  </div>

  <main class="main">
    <div id="errorBanner" class="error-banner" style="display:none"></div>
    <div id="newsContainer">
      <div class="state-empty">
        <div class="state-empty-icon">ğŸ“°</div>
        <div class="state-empty-text">
          æ·»åŠ å…³é”®è¯ï¼Œé€‰æ‹©æ—¶é—´èŒƒå›´<br>ç‚¹å‡»ã€Œè·å–æ–°é—»ã€å¼€å§‹
        </div>
      </div>
    </div>
  </main>

  <footer>ç®€æŠ¥ Â· æ•°æ®æ¥æºï¼šGoogle News &amp; NewsAPI Â· æ‘˜è¦ç”± Gemini AI ç”Ÿæˆ</footer>

  <!-- è®¾ç½®å¼¹çª— -->
  <div class="modal-overlay" id="settingsModal" onclick="closeSettingsOutside(event)">
    <div class="modal">
      <div class="modal-title">âš™ è®¾ç½®</div>

      <div class="modal-section">
        <div class="modal-label">Gemini API Key</div>
        <div class="modal-desc">
          ç”¨äºæ–°é—»å»é‡å’Œä¸­æ–‡æ‘˜è¦ç”Ÿæˆã€‚<a href="https://aistudio.google.com/app/apikey" target="_blank">ç‚¹å‡»æ­¤å¤„å…è´¹ç”³è¯·</a>ï¼Œé€‰æ‹©å…è´¹å¥—é¤å³å¯ã€‚
        </div>
        <div style="display:flex;gap:8px">
          <input type="password" id="geminiKey" class="api-key-input" placeholder="AIza..." style="width:280px;font-family:monospace;font-size:0.75rem" />
          <button class="btn btn-outline" onclick="saveApiKey()">ä¿å­˜</button>
        </div>
        <div class="api-status" id="apiStatus" style="margin-top:6px"></div>
      </div>

      <div class="modal-section">
        <div class="modal-label">NewsAPI Keyï¼ˆå¯é€‰ï¼‰</div>
        <div class="modal-desc">
          ç”¨äºè·å–æ›´å¤šè‹±æ–‡æ–°é—»æ¥æºã€‚<a href="https://newsapi.org/register" target="_blank">ç‚¹å‡»æ­¤å¤„å…è´¹ç”³è¯·</a>ã€‚ä¸å¡«åˆ™åªä½¿ç”¨ Google Newsã€‚
        </div>
        <div style="display:flex;gap:8px">
          <input type="text" id="newsapiKey" class="api-key-input" placeholder="ç•™ç©ºåˆ™ä¸ä½¿ç”¨" style="width:280px;font-family:monospace;font-size:0.75rem" />
          <button class="btn btn-outline" onclick="saveNewsApiKey()">ä¿å­˜</button>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeSettings()">å…³é—­</button>
      </div>
    </div>
  </div>

<script>
// â”€â”€â”€ çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let keywords = JSON.parse(localStorage.getItem('jb_keywords') || '["Gemini","ç‰¹æœ—æ™®","é»„é‡‘","AI"]');
let geminiKey = localStorage.getItem('jb_gemini_key') || '';
let newsapiKey = localStorage.getItem('jb_newsapi_key') || '';

// â”€â”€â”€ åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('todayDate').textContent = new Date().toLocaleDateString('zh-CN', {
  year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
});
document.getElementById('kwInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') addKeyword();
});
renderTags();

function renderTags() {
  const el = document.getElementById('kwTags');
  el.innerHTML = keywords.map((kw, i) => `
    <div class="tag">
      ${kw}
      <span class="tag-remove" onclick="removeKeyword(${i})">âœ•</span>
    </div>
  `).join('');
}
function addKeyword() {
  const v = document.getElementById('kwInput').value.trim();
  if (v && !keywords.includes(v)) {
    keywords.push(v);
    localStorage.setItem('jb_keywords', JSON.stringify(keywords));
    renderTags();
  }
  document.getElementById('kwInput').value = '';
}
function removeKeyword(i) {
  keywords.splice(i, 1);
  localStorage.setItem('jb_keywords', JSON.stringify(keywords));
  renderTags();
}

// â”€â”€â”€ è®¾ç½®å¼¹çª— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSettings() {
  document.getElementById('geminiKey').value = geminiKey;
  document.getElementById('newsapiKey').value = newsapiKey;
  document.getElementById('apiStatus').textContent = '';
  document.getElementById('settingsModal').classList.add('open');
}
function closeSettings() {
  document.getElementById('settingsModal').classList.remove('open');
}
function closeSettingsOutside(e) {
  if (e.target === document.getElementById('settingsModal')) closeSettings();
}
function saveApiKey() {
  const v = document.getElementById('geminiKey').value.trim();
  geminiKey = v;
  localStorage.setItem('jb_gemini_key', v);
  const st = document.getElementById('apiStatus');
  st.textContent = v ? 'âœ“ å·²ä¿å­˜' : 'å·²æ¸…é™¤';
  st.className = 'api-status ok';
}
function saveNewsApiKey() {
  const v = document.getElementById('newsapiKey').value.trim();
  newsapiKey = v;
  localStorage.setItem('jb_newsapi_key', v);
}

// â”€â”€â”€ æ ¸å¿ƒï¼šè·å–æ–°é—» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchNews() {
  if (!keywords.length) {
    showError('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ªå…³é”®è¯');
    return;
  }
  if (!geminiKey) {
    showError('è¯·å…ˆåœ¨ã€Œè®¾ç½®ã€ä¸­å¡«å†™ Gemini API Key');
    openSettings();
    return;
  }

  const days = parseInt(document.getElementById('timeRange').value);
  showLoading();
  hideError();

  try {
    // 1. ä» Google News RSS æŠ“å–ï¼ˆé€šè¿‡ allorigins ä»£ç†ï¼‰
    let allArticles = [];
    for (const kw of keywords) {
      const articles = await fetchGoogleNews(kw, days);
      allArticles = allArticles.concat(articles.map(a => ({...a, keyword: kw})));
    }

    // 2. å¦‚æœæœ‰ NewsAPI keyï¼Œä¹ŸæŠ“å–
    if (newsapiKey) {
      for (const kw of keywords) {
        const articles = await fetchNewsAPI(kw, days);
        allArticles = allArticles.concat(articles.map(a => ({...a, keyword: kw})));
      }
    }

    if (!allArticles.length) {
      showEmpty('æœªæ‰¾åˆ°ç›¸å…³æ–°é—»ï¼Œè¯·å°è¯•æ›´æ¢å…³é”®è¯æˆ–æ‰©å¤§æ—¶é—´èŒƒå›´');
      return;
    }

    // 3. ç”¨ Gemini å»é‡èšåˆç”Ÿæˆæ‘˜è¦
    const grouped = await groupAndSummarize(allArticles, days);
    renderNews(grouped);

  } catch (err) {
    console.error(err);
    showError('è·å–å¤±è´¥ï¼š' + err.message);
  }
}

// â”€â”€â”€ Google News RSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchGoogleNews(keyword, days) {
  const url = `https://news.google.com/rss/search?q=${encodeURIComponent(keyword)}&hl=zh-CN&gl=CN&ceid=CN:zh-Hans`;
  const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
  const res = await fetch(proxy);
  const data = await res.json();
  const parser = new DOMParser();
  const xml = parser.parseFromString(data.contents, 'text/xml');
  const items = xml.querySelectorAll('item');
  const cutoff = Date.now() - days * 86400000;
  const articles = [];
  items.forEach(item => {
    const pubDate = new Date(item.querySelector('pubDate')?.textContent || 0);
    if (pubDate.getTime() < cutoff) return;
    const title = item.querySelector('title')?.textContent || '';
    const link = item.querySelector('link')?.textContent || '';
    const source = item.querySelector('source')?.textContent || 'Google News';
    articles.push({ title, link, source, publishedAt: pubDate.toISOString() });
  });
  return articles.slice(0, 15);
}

// â”€â”€â”€ NewsAPI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchNewsAPI(keyword, days) {
  const from = new Date(Date.now() - days * 86400000).toISOString().split('T')[0];
  const url = `https://newsapi.org/v2/everything?q=${encodeURIComponent(keyword)}&from=${from}&sortBy=publishedAt&pageSize=10&apiKey=${newsapiKey}`;
  const res = await fetch(url);
  const data = await res.json();
  if (data.status !== 'ok') return [];
  return (data.articles || []).map(a => ({
    title: a.title,
    link: a.url,
    source: a.source?.name || 'NewsAPI',
    publishedAt: a.publishedAt
  }));
}

// â”€â”€â”€ Gemini å»é‡èšåˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function groupAndSummarize(articles, days) {
  // æŒ‰å…³é”®è¯åˆ†ç»„
  const byKeyword = {};
  articles.forEach(a => {
    if (!byKeyword[a.keyword]) byKeyword[a.keyword] = [];
    byKeyword[a.keyword].push(a);
  });

  const results = [];

  for (const [kw, arts] of Object.entries(byKeyword)) {
    if (!arts.length) continue;

    const articleList = arts.map((a, i) =>
      `${i+1}. æ ‡é¢˜ï¼š${a.title}\n   æ¥æºï¼š${a.source}\n   æ—¶é—´ï¼š${new Date(a.publishedAt).toLocaleDateString('zh-CN')}\n   é“¾æ¥ï¼š${a.link}`
    ).join('\n\n');

    const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–°é—»ç¼–è¾‘ã€‚ä»¥ä¸‹æ˜¯å…³äºå…³é”®è¯ã€Œ${kw}ã€åœ¨æœ€è¿‘${days}å¤©å†…æ”¶é›†åˆ°çš„æ–°é—»åˆ—è¡¨ï¼š

${articleList}

è¯·å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š
1. å°†å†…å®¹ç›¸ä¼¼æˆ–åŒä¸€äº‹ä»¶çš„æ–°é—»å½’ä¸ºä¸€ç»„
2. å¯¹æ¯ç»„ç”Ÿæˆä¸€ä¸ªç®€æ´çš„ä¸­æ–‡æ ‡é¢˜ï¼ˆ15å­—ä»¥å†…ï¼‰
3. å¯¹æ¯ç»„ç”Ÿæˆä¸€æ®µä¸­æ–‡æ‘˜è¦ï¼ˆ100-150å­—ï¼‰ï¼Œæ¦‚æ‹¬æ ¸å¿ƒäº‹ä»¶ã€æ—¶é—´ã€å½±å“
4. æ¯ç»„ä¿ç•™æ‰€æœ‰æ¥æºé“¾æ¥

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ï¼š
[
  {
    "headline": "èšåˆæ ‡é¢˜",
    "summary": "ä¸­æ–‡æ‘˜è¦å†…å®¹",
    "sources": [
      {"name": "æ¥æºå", "url": "é“¾æ¥", "date": "æ—¥æœŸ"}
    ]
  }
]`;

    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.3, maxOutputTokens: 2048 }
        })
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error.message);
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '[]';
      const clean = text.replace(/```json|```/g, '').trim();
      const groups = JSON.parse(clean);
      groups.forEach(g => results.push({ ...g, keyword: kw }));
    } catch (e) {
      // Geminiå¤±è´¥åˆ™ç›´æ¥æ˜¾ç¤ºåŸå§‹æ ‡é¢˜
      arts.forEach(a => results.push({
        headline: a.title,
        summary: '',
        sources: [{ name: a.source, url: a.link, date: new Date(a.publishedAt).toLocaleDateString('zh-CN') }],
        keyword: kw
      }));
    }
  }

  return results;
}

// â”€â”€â”€ æ¸²æŸ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNews(groups) {
  const container = document.getElementById('newsContainer');
  if (!groups.length) {
    showEmpty('æœªæ‰¾åˆ°ç›¸å…³æ–°é—»');
    return;
  }

  const timeLabel = document.getElementById('timeRange').options[document.getElementById('timeRange').selectedIndex].text;

  container.innerHTML = `
    <div class="section-header">
      <div class="section-title">æ–°é—»æ‘˜è¦</div>
      <div class="section-count">${timeLabel} Â· å…± ${groups.length} æ¡</div>
    </div>
    <div class="news-grid">
      ${groups.map((g, i) => `
        <div class="news-card" style="animation-delay:${i * 0.05}s">
          <div>
            <div class="news-keyword-badge"># ${g.keyword}</div>
            <div class="news-headline">${g.headline}</div>
            ${g.summary ? `<div class="news-summary">${g.summary}</div>` : ''}
            <div class="news-sources">
              ${g.sources.map(s => `
                <a class="source-link" href="${s.url}" target="_blank" rel="noopener">
                  ${s.name}${s.date ? ' Â· ' + s.date : ''}
                </a>
              `).join('')}
            </div>
          </div>
          <div class="news-meta">${g.sources.length} ä¸ªæ¥æº</div>
        </div>
      `).join('')}
    </div>
  `;
}

// â”€â”€â”€ å·¥å…·å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLoading() {
  document.getElementById('newsContainer').innerHTML = `
    <div class="state-loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">æ­£åœ¨æŠ“å–å¹¶åˆ†ææ–°é—»ï¼Œè¯·ç¨å€™â€¦</div>
    </div>
  `;
}
function showEmpty(msg) {
  document.getElementById('newsContainer').innerHTML = `
    <div class="state-empty">
      <div class="state-empty-icon">ğŸ”</div>
      <div class="state-empty-text">${msg}</div>
    </div>
  `;
}
function showError(msg) {
  const el = document.getElementById('errorBanner');
  el.textContent = 'âš  ' + msg;
  el.style.display = 'block';
}
function hideError() {
  document.getElementById('errorBanner').style.display = 'none';
}
</script>
</body>
</html>
